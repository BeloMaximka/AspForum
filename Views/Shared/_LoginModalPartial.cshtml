@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}

<div class="modal fade" id="loginModal" tabindex="-1" style="display: none;" aria-hidden="true">
	<div class="modal-dialog">

		<!-- Modal content -->
		<div class="modal-content">
			<!-- Modal body -->
			<div class="modal-body">

				<!-- Pills navs -->
				<ul class="nav nav-pills nav-justified mb-3" role="tablist">
					<li class="nav-item" role="presentation">
						<a class="nav-link" data-mdb-toggle="pill" href="#navbarLogin-login" role="tab" aria-selected="true">Login</a>
					</li>
					<li class="nav-item" role="presentation">
						<a class="nav-link active show" data-mdb-toggle="pill" href="#navbarLogin-signup" role="tab" aria-selected="false" tabindex="-1">Register</a>
					</li>
				</ul>

				<!-- Pills panels -->
				<div class="tab-content">

					<!--Login Panel-->
					<div class="tab-pane fade" id="navbarLogin-login" role="tabpanel">

						<!-- Default form login -->
						<form id="loginForm" class="text-center needs-validation" method="post" asp-controller="Account" asp-action="Register">

							<p class="status"></p>

							<div class="text-center mb-3">
								<div class="wp-social-login-widget">
									<div class="wp-social-login-connect-with">Connect with:</div>
									<div class="wp-social-login-provider-list">
										<a rel="nofollow" href="" title="Connect with Facebook" class="btn btn-primary btn-floating mx-1 ripple-surface" data-provider="Facebook" role="button" style="min-width: 37px;"><i class="fab fa-facebook-f"></i></a>
										<a rel="nofollow" href="" title="Connect with Google" class="btn btn-primary btn-floating mx-1" data-provider="Google" role="button"><i class="fab fa-google"></i></a>
										<a rel="nofollow" href="" title="Connect with Twitter" class="btn btn-primary btn-floating mx-1" data-provider="Twitter" role="button"><i class="fab fa-twitter"></i></a>
									</div>
								</div>
							</div>

							<p class="text-center">or:</p>

							<!-- Email input -->
							<div class="form-outline form-auth-mdb mb-4">
								<input type="text" id="loginUsername" class="form-control" required="">
								<label class="form-label" for="loginUsername" style="margin-left: 0px;">Your e-mail or username</label>
								<div class="form-notch"><div class="form-notch-leading" style="width: 9px;"></div><div class="form-notch-middle" style="width: 146.4px;"></div><div class="form-notch-trailing"></div></div>
							</div>

							<!-- Password input -->
							<div class="form-outline form-auth-mdb mb-4">
								<input type="password" id="loginPassword" class="form-control" autocomplete="off" required="">
								<label class="form-label" for="loginPassword" style="margin-left: 0px;">Your password</label>
								<div class="form-notch"><div class="form-notch-leading" style="width: 9px;"></div><div class="form-notch-middle" style="width: 92.8px;"></div><div class="form-notch-trailing"></div></div>
							</div>

							<!-- Remember me checkbox -->
							<div class="form-check d-flex justify-content-start">
								<input type="checkbox" id="loginRememberMe" class="form-check-input me-1" >
								<label class="form-check-label" for="loginRememberMe">Remember me</label>
							</div>

							<!-- 2 column grid layout for inline styling -->
							<div class="justify-content-center mb-4">
								<a href="">Forgot password?</a>
							</div>

							<button id="LoginBtn" class="btn btn-primary btn-block mb-4" type="button">Sign in</button>

							<div id="loginFeedback" class="text-danger"></div>

							<!-- Register buttons -->
							<div class="text-center">
								<p>Not a member? <a href="#" class="auth-modal-toggle" data-auth-modal-tab="sign-up">Register</a></p>
							</div>

						</form>
						<!-- Default form login -->

					</div>
					<!--/.Login Panel-->
					<!--Registration Panel -->
					<div class="tab-pane fade in show active" id="navbarLogin-signup" role="tabpanel">

						<!-- Default form register  -->
						<form id="registerForm" class="text-center needs-validation" method="post" asp-controller="Account" asp-action="Register">

							<!-- Social login -->

							<p class="status"></p>

							<div class="text-center mb-3">
								<div class="wp-social-login-widget">
									<div class="wp-social-login-connect-with">Connect with:</div>
									<div class="wp-social-login-provider-list">
										<a rel="nofollow" href="" title="Connect with Facebook" class="btn btn-primary btn-floating mx-1 ripple-surface" data-provider="Facebook" role="button" style="min-width: 37px;"><i class="fab fa-facebook-f"></i></a>
										<a rel="nofollow" href="" title="Connect with Google" class="btn btn-primary btn-floating mx-1" data-provider="Google" role="button"><i class="fab fa-google"></i></a>
										<a rel="nofollow" href="" title="Connect with Twitter" class="btn btn-primary btn-floating mx-1" data-provider="Twitter" role="button"><i class="fab fa-twitter"></i></a>
									</div>
								</div>
							</div>
							<!-- Social login -->

							<p class="text-center">or:</p>

							<!-- Username input -->
							<div class="form-outline form-auth-mdb mb-4">
								<input type="text" id="registerUsername" class="form-control" required minlength="3">
								<label class="form-label" style="margin-left: 0px;">Your username</label>
								<div class="invalid-feedback">Please provide a valid username.</div>
								<div class="form-notch"><div class="form-notch-leading" style="width: 9px;"></div><div class="form-notch-middle" style="width: 8px;"></div><div class="form-notch-trailing"></div></div>
							</div>

							<!-- Email input -->
							<div class="form-outline form-auth-mdb mb-4">
								<input type="email" id="registerEmail" class="form-control" required="">
								<label class="form-label" style="margin-left: 0px;">Your email</label>
								<div class="invalid-feedback">Please provide a valid email.</div>
								<div class="form-notch"><div class="form-notch-leading" style="width: 9px;"></div><div class="form-notch-middle" style="width: 8px;"></div><div class="form-notch-trailing"></div></div>
							</div>

							<!-- Password input -->
							<div class="form-outline form-auth-mdb mb-4">
								<input type="password" id="registerPassword" class="form-control" autocomplete="off" required="" minlength="5">
								<label class="form-label" style="margin-left: 0px;">Your password</label>
								<div class="invalid-feedback">Please provide a valid password.</div>
								<div class="form-notch"><div class="form-notch-leading" style="width: 9px;"></div><div class="form-notch-middle" style="width: 8px;"></div><div class="form-notch-trailing"></div></div>
							</div>

							<!-- Repeat Password input -->
							<div class="form-outline form-auth-mdb mb-4">
								<input type="password" id="registerPasswordConfirm" class="form-control" autocomplete="off" required="" minlength="5">
								<label class="form-label" style="margin-left: 0px;">Repeat password</label>
								<div asp-validation-for="PasswordConfirm" class="invalid-feedback">Password mismatch.</div>
								<div class="form-notch"><div class="form-notch-leading" style="width: 9px;"></div><div class="form-notch-middle" style="width: 8px;"></div><div class="form-notch-trailing"></div></div>
							</div>

							<!-- Agree checkbox -->
							<div class="form-check d-flex justify-content-center">
								<input type="checkbox" id="registerIsAgree" class="form-check-input me-1" required>
								<label class="form-check-label" for="registerIsAgree">I have read and agree to the terms</label>
							</div>

							<button class="btn btn-primary btn-block mb-3" id="RegisterBtn" type="button" onsubmit="return false" value="SIGNUP">
								Sign up
							</button>

							<div id="registerFeedback" class="text-danger"></div>

						</form>
						<!-- Default form register  -->

					</div>
					<!--/.Registration Panel -->

				</div>
				<!-- Pills panels -->

			</div>
			<!-- Modal footer -->
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">
					Close
				</button>
			</div>
		</div>
		<!-- Modal content -->
	</div>
</div>

<script type="text/javascript">
	document.addEventListener("DOMContentLoaded", () => {
		const antiForgeryToken = document.querySelectorAll('input[name=__RequestVerificationToken]')[0].value;

		// Register
		const registerBtn = document.getElementById("RegisterBtn");
		const registerUsernameInput = document.getElementById("registerUsername");
		const registerEmailInput = document.getElementById("registerEmail");
		const registerPasswordInput = document.getElementById("registerPassword");
		const registerPasswordConfirmInput = document.getElementById("registerPasswordConfirm");
		const isAgreeInput = document.getElementById("registerIsAgree");
		const registerForm = document.getElementById("registerForm");
		const registerServerFeedback = document.getElementById("registerFeedback");

		registerBtn.addEventListener("click", () => {
			registerForm.classList.add("was-validated");
			registerServerFeedback.innerText = "";

			// Password match validation
			const password = registerPasswordInput.value;
			const passwordConfirm = registerPasswordConfirmInput.value;
			if(password !== passwordConfirm) {
				registerPasswordConfirmInput.classList.add("is-invalid");
				return;
			}
			else {
				registerPasswordConfirmInput.classList.remove("is-invalid");
			}

			if (registerForm.checkValidity()) {
				const username = registerUsernameInput.value;
				const email = registerEmailInput.value;
				const isAgree = isAgreeInput.checked;

				fetch("Account/Register", {
					body: `Username=${username}&Email=${email}&Password=${password}&PasswordConfirm=${passwordConfirm}&IsAgree=${isAgree}`,
					headers: {
						"Content-Type": "application/x-www-form-urlencoded",
					},
					method: "post",
				})
					.then(r => r.json())
					.then(j => {
						if (j.success === true) {
							window.location.href = "/Account/SuccessfulRegistration";
						}
						else {
							j.errors.forEach(e => registerServerFeedback.innerText += e + "\n");
						}
					});
			}
			else
			{
				registerForm.reportValidity();
				return;
			}
		});

		// Login
		const loginForm = document.getElementById("loginForm");
		const loginBtn = document.getElementById("LoginBtn");
		const loginUsernameInput = document.getElementById("loginUsername");
		const loginPasswordInput = document.getElementById("loginPassword");
		const loginRememberMe = document.getElementById("loginRememberMe");
		const loginServerFeedback = document.getElementById("loginFeedback");

		loginBtn.addEventListener("click", () => {
			loginServerFeedback.innerText = "";

			const username = loginUsernameInput.value;
			const password = loginPasswordInput.value;
			const rememberMe = loginRememberMe.checked;

			fetch("Account/Login", {
				body: `Username=${username}&Password=${password}&RememberMe=${rememberMe}&__RequestVerificationToken=${antiForgeryToken}`,
				headers: {
					"Content-Type": "application/x-www-form-urlencoded",
				},
				method: "post",
			})
				.then(r => r.json())
				.then(j => {
					if (j.success === true) {
						window.location.reload();
					}
					else {
						loginServerFeedback.innerText = j.message;
					}
				});
		});
	});
</script>